#!/bin/bash

source $HOME/bin/commons.sh

# Read the name of the origin branch
echo "Enter the name of the origin branch (default $STABLE_BRANCH):"
read ORIGIN_BRANCH

if [ -z $ORIGIN_BRANCH ]; then
    ORIGIN_BRANCH=$STABLE_BRANCH
fi


if [ $ORIGIN_BRANCH = "main" ]; then
    ORIGIN_BRANCH_URL="svn+ssh://crpi@repository_sag/home/repository/svn/matlab/matlab/"$ORIGIN_BRANCH
else
    ORIGIN_BRANCH_URL="svn+ssh://crpi@repository_sag/home/repository/svn/matlab/matlab/production/"$ORIGIN_BRANCH
fi


# Read the name of the new branch from the keyboard
echo 'Enter the name of the new research branch:'
read TARGET_BRANCH


# Generate the Log message
LOG_MESSAGE="MatlabInfo:branch; origin:$ORIGIN_BRANCH; target:$TARGET_BRANCH; description: Creating a new research branch; timestamp: "`date +"%a %b %d %H:%M:%S %Y"`";"

# Generate the SVN COPY command
SVN_TARGET='svn+ssh://crpi@repository_sag/home/repository/svn/matlab/matlab/research/'$TARGET_BRANCH

# Check that the SVN_TARGET does not already exist
RESULT=`svn ls $SVN_TARGET`
if [ ! -z "$RESULT" ]; then
    echo -e "\n\n"
    echo "ERROR!!! Research branch '$SVN_TARGET' already exists. You will have to choose an other name."
    echo -e "\n\n"
    exit 0
fi


COPY_COMMAND='svn cp -m '"\"$LOG_MESSAGE\" $ORIGIN_BRANCH_URL $SVN_TARGET"


## Print info about the new branch

echo -e "\n\n"
echo "About to generate new research branch:"
echo "-------------------------------------------"
echo "Origin: "$ORIGIN_BRANCH
echo "Target: "$TARGET_BRANCH
echo ""
echo "SVN target: "$SVN_TARGET
echo "-------------------------------------------"
echo ""
echo "Command: " $COPY_COMMAND
echo ""

echo "Would you like to continue? [y/n]"
read ANSWER


# Run the copy command
case $ANSWER in
    y|Y|yes|Yes|YES)
        echo $COPY_COMMAND | bash;;
    *) 
        echo "Branch $TARGET_BRANCH will not be created. Exiting!"; exit 1;;
esac


## Enter the branch information into the database
echo "Enter revision number (should be printed above): "
read REVISION_NUMBER

echo 'Enter the name of the researcher responsible for the branch: '
read RESPONSIBLE

SVN_TARGET_FOR_DB=`echo $SVN_TARGET | replacestr 'crpi@' ''`

echo " "
echo "Inserting merge information into the database: $MATLAB_DATABASE"
InsertSvnBranch "$ORIGIN_BRANCH" "$TARGET_BRANCH" "$REVISION_NUMBER" "$RESPONSIBLE" "$SVN_TARGET_FOR_DB" "RESEARCH" "ACTIVE"
InsertSvnMerge "$ORIGIN_BRANCH" "$TARGET_BRANCH" "$REVISION_NUMBER"-"$REVISION_NUMBER" "$RESPONSIBLE"


## Send an e-mail to the RESPONSIBLE
EMAIL_BODY="Hi $RESPONSIBLE,\n
\n
your new research branch $TARGET_BRANCH is here: \n
\n
`echo $SVN_TARGET | replacestr 'crpi@' ''`\n
\n
Cheers,\n
Cristian\n
\n
PS: This e-mail was automatically generated by the script that created the research branch.
"

SendEMail "New research branch: $TARGET_BRANCH" "$EMAIL_BODY" "$RESPONSIBLE"@imc.nl "crpi@imc.nl" "crpi@imc.nl"
