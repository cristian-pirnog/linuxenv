#!/bin/bash

source ~/bin/commons.sh

# Read the name of the origin branch
echo "Enter the name of the origin branch (default $STABLE_BRANCH):"
read ORIGIN_BRANCH

if [ -z $ORIGIN_BRANCH ]; then
    ORIGIN_BRANCH=$STABLE_BRANCH
fi


# Read the name of the new branch from the keyboard
echo 'Enter the name of the bug (e.g. SAGMIM_123):'
read BUG_NAME

TARGET_BRANCH="$ORIGIN_BRANCH"_"$BUG_NAME"

# Generate the Log message
LOG_MESSAGE="MatlabInfo:branch; origin:$ORIGIN_BRANCH; target:$TARGET_BRANCH; description: Creating a new bug fix branch; timestamp: "`date +"%a %b %d %H:%M:%S %Y"`";"

# Generate the SVN COPY command
SVN_TARGET='svn+ssh://crpi@repository_sag/home/repository/svn/matlab/matlab/bug_fixes/'$TARGET_BRANCH

# Check that the SVN_TARGET does not already exist
RESULT=`svn ls $SVN_TARGET`
if [ ! -z "$RESULT" ]; then
    echo -e "\n\n"
    echo "ERROR!!! Bug fix branch '$SVN_TARGET' already exists. You will have to choose an other name."
    echo -e "\n\n"
    exit 0
fi


COPY_COMMAND='svn cp -m '"\"$LOG_MESSAGE\""' svn+ssh://crpi@repository_sag/home/repository/svn/matlab/matlab/production/'$ORIGIN_BRANCH" $SVN_TARGET"


## Print info about the new branch

echo -e "\n\n"
echo "About to generate new bug_fix branch:"
echo "-------------------------------------------"
echo "Origin: "$ORIGIN_BRANCH
echo "Target: "$TARGET_BRANCH
echo ""
echo "SVN target: "$SVN_TARGET
echo "-------------------------------------------"
echo ""
echo "Command: " $COPY_COMMAND
echo ""

echo "Would you like to continue? [y/n]"
read ANSWER


# Run the copy command
case $ANSWER in
    y|Y|yes|Yes|YES)
        echo $COPY_COMMAND | bash;;
    *) 
        echo "Branch $TARGET_BRANCH will not be created. Exiting!"; exit 0;;
esac

## Enter the branch information into the database
echo "Enter revision number (should be printed above): "
read REVISION_NUMBER

echo 'Enter the name of the researcher responsible for the branch: '
read RESPONSIBLE

SVN_TARGET_FOR_DB=`echo $SVN_TARGET | replacestr 'crpi@' ''`


echo " "
echo "Inserting merge information into the (LOCAL) database: $DATABASE_COMMAND"
InsertSvnBranch "$ORIGIN_BRANCH" "$TARGET_BRANCH" "$REVISION_NUMBER" "$RESPONSIBLE" "$SVN_TARGET_FOR_DB" "" "ACTIVE"
InsertSvnMerge "$ORIGIN_BRANCH" "$TARGET_BRANCH" "$REVISION_NUMBER"-"$REVISION_NUMBER" "$RESPONSIBLE"
