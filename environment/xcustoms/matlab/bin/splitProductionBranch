#!/bin/bash

source ~/bin/commons.sh

echo "Select the branch type:"
echo "   1) java porting"
echo "   2) new features"

read ANSWER
if [ $ANSWER == "1" ]; then
    ORIGIN_BRANCH=`GetLatestProductionBranch`
    ORIGIN_BRANCH_TYPE="production/"
    TARGET_BRANCH_NAME=`echo $ORIGIN_BRANCH | sed "s/_TB[0-9][0-9]//g"`
elif [ $ANSWER == "2" ]; then
    ORIGIN_BRANCH='main'
    ORIGIN_BRANCH_TYPE=""
    # Read the name of the new branch from the keyboard
    echo 'Enter the name of the new production branch:'
    read TARGET_BRANCH_NAME
else
    echo "Invalid option $ANSWER. Exiting."
    exit 1
fi

echo 'Enter the Java release version on which this branch will depend (e.g. TB11): '
read JAVA_RELEASE_VERSION

# Check that the branch name ends with _TBxy (where xy is a two digit number)
if [ -z `echo $JAVA_RELEASE_VERSION|grep -G 'TB[[:digit:]]\{2\}$'` ]; then
    echo "The java release version ($JAVA_RELEASE_VERSION|grep) is not of type TBxy"
    exit 1
fi

# Build the TARGET_BRANCH 
TARGET_BRANCH="$TARGET_BRANCH_NAME"_"$JAVA_RELEASE_VERSION"

# Generate the Log message
LOG_MESSAGE="MatlabInfo:branch; origin:$ORIGIN_BRANCH; target:$TARGET_BRANCH; description: Creating a new production branch; timestamp: $TIME_STAMP;"

# Generate the SVN COPY command
SVN_TARGET='svn+ssh://crpi@repository_sag/home/repository/svn/matlab/matlab/production/'$TARGET_BRANCH

# Check that the SVN_TARGET does not already exist
RESULT=`svn ls $SVN_TARGET`
if [ ! -z "$RESULT" ]; then
    echo -e "\n\n"
    echo "ERROR!!! Research branch '$SVN_TARGET' already exists. You will have to choose an other name."
    echo -e "\n\n"
    exit 0
fi


COPY_COMMAND='svn cp -m '"\"$LOG_MESSAGE\""' svn+ssh://crpi@repository_sag/home/repository/svn/matlab/matlab/'${ORIGIN_BRANCH_TYPE}${ORIGIN_BRANCH}" $SVN_TARGET"

## Print info about the new branch

echo -e "\n\n"
echo "About to generate new research branch:"
echo "-------------------------------------------"
echo "Origin: "$ORIGIN_BRANCH
echo "Target: "$TARGET_BRANCH
echo ""
echo "SVN target: "$SVN_TARGET
echo "-------------------------------------------"
echo ""
echo "Command: " $COPY_COMMAND
echo ""

echo "Would you like to continue? [y/n]"
read ANSWER


# Run the copy command
case $ANSWER in
    y|Y|yes|Yes|YES)
        echo $COPY_COMMAND | bash;;
    *) 
        echo "Branch $TARGET_BRANCH will not be created. Exiting!"; exit 0;;
esac

echo "Enter revision number (should be printed above): "
read REVISION_NUMBER

echo 'Enter the name of the researcher responsible for the branch: '
read RESPONSIBLE

SVN_TARGET_FOR_DB=`echo $SVN_TARGET | replacestr 'crpi@' ''`

echo " "
echo "Inserting merge information into the database: $MATLAB_DATABASE"
InsertSvnBranch "$ORIGIN_BRANCH" "$TARGET_BRANCH" "$REVISION_NUMBER" "$RESPONSIBLE" "$SVN_TARGET_FOR_DB" "PRODUCTION" "IN_DEVELOPMENT"
InsertSvnMerge "$ORIGIN_BRANCH" "$TARGET_BRANCH" "$REVISION_NUMBER"-"$REVISION_NUMBER" "$RESPONSIBLE"


## Send an e-mail to the RESPONSIBLE
EMAIL_BODY="Hi $RESPONSIBLE,\n
\n
the new production branch $TARGET_BRANCH is here: \n
\n
`echo $SVN_TARGET | replacestr 'crpi@' ''`\n
\n
Cheers,\n
Cristian\n
\n
PS: This e-mail was automatically generated by the script that created the research branch.
"

SendEMail "New research branch: $TARGET_BRANCH" "$EMAIL_BODY" "$RESPONSIBLE"@imc.nl "crpi@imc.nl" "crpi@imc.nl"
