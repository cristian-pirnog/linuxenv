#! /bin/bash

# Check when the last day is that has data in Constantijn

## Parse the input arguments
if [ $# -gt 1 ]
then
    echo -e "Usage:\n\t`basename $0`  [NrOfDays]"
    exit 1
elif [ $# -eq 1 ]
then
    NR_DAYS=$1
else
    NR_DAYS=10
fi


# Check whether CONSTANTIJN_PATH is set
if [ -z $CONSTANTIJN_PATH ]
then
    echo "Environment variable CONSTANTIJN_PATH is not set."
    exit
fi

## Change dir to CONSTANTIJN_PATH
cd $CONSTANTIJN_PATH

## Get the number of pairs
NR_OF_PAIRS=`find .  -mindepth 1 -maxdepth 1 -type d | wc -l`

# Search for the past NR_DAYS days
myCounter=0
while [ $myCounter -lt $NR_DAYS ]
do
  ((myCounter = myCounter + 1))

  # Construct the name of the date directory
  DATE=`date +%Y.%m.%d -d "$myCounter days ago"`
  
  # Check whether the date directory exists
  DATE_DIR_COUNT=`ls $CONSTANTIJN_PATH/*/$DATE 2>/dev/null | wc -l`
  if [ $DATE_DIR_COUNT -gt 0 ]  # If result from 'ls' is not 2 (serious problems) ==> date directories exist
  then
      NR_OF_LINES=`ls */$DATE/*.nc3r | wc -l`

      if [ $NR_OF_LINES -gt 0 ]
      then
          echo "Last day of data in Constantijn is: $DATE (with $NR_OF_LINES nc3r files for $NR_OF_PAIRS pairs)"
          exit 0
      else
          echo "$NR_OF_LINES lines found for date $DATE"
      fi
  else
      echo "DATE=$DATE ==> DATE_DIR_COUNT = $DATE_DIR_COUNT"
  fi
done

## If we're as far as here ==> we couldn't find any day that has data
echo "The last day of data in Constantijn is not within the past $NR_DAYS days"
