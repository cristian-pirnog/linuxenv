#!/bin/bash

#----------------------------------------------
printCopyrightText()
{
    fileName=$(basename ${1})
    beginComment="${2}"
    comment="${3}"
    endComment="${4}"

cat << %%COPYRIGHT%% 
${beginComment} *******************************COPYRIGHT********************************
${comment}
${comment} File: ${fileName}
${comment}
${comment} Katania Copyright
${comment}
${comment} 2014 Katania Ltd
${comment} All Rights Reserved
${comment}
${comment} All information contained herein is and remains the property of Katania
${comment} Ltd and its suppliers, if any. The intellectual and technical concepts
${comment} contained herein are confidential and proprietary to Katania Ltd and
${comment} its suppliers and may be covered by U.S. and Foreign Patents (or
${comment} patents in process) and are protected by trade secret and/or copyright
${comment} law. Dissemination of this information or reproduction of this material
${comment} is strictly forbidden unless prior written permission is obtained from 
${comment} Katania Ltd.
${comment}
${comment} Unless required by applicable law or agreed to in writing, this software
${comment} is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF 
${comment} ANY KIND, either expressed or implied.
${comment} 
${comment} *******************************COPYRIGHT*******************************${endComment}

%%COPYRIGHT%%
}

#----------------------------------------------
handleCpp()
{
    local lFileName=${1}
    local lDoReplace=${2}
    local lBeginComment='/*'
    local lComment=' *'
    local lEndComment='*/'

    if [[ ${doReplace} -eq 1 ]]; then
	echo Replacing copyright text in ${fileName}
	sed -i '/\*\*\*\*COPYRIGHT\*\*\*\*/,/\*\*\*COPYRIGHT\*\*\*/d' ${lFileName}
    else
	echo Adding copyright text to ${fileName}
    fi

    local lTmpFile=$(mktemp)
    > ${lTmpFile}
    printCopyrightText ${lFileName} "${lBeginComment}" "${lComment}" "${lEndComment}" >> ${lTmpFile}
    cat ${lFileName} >> ${lTmpFile}
    mv ${lTmpFile} ${lFileName}
}

#----------------------------------------------
handlePython()
{
    local lFileName=${1}
    local lDoReplace=${2}
    local lBeginComment='#'
    local lComment='#'
    local lEndComment=''

    if [[ ${doReplace} -eq 1 ]]; then
	echo Replacing copyright text in ${fileName}
    else
	echo Adding copyright text to ${fileName}
    fi

    local lTmpFile=$(mktemp)
    > ${lTmpFile}
    local lOffset=0
    if [[ $(head -1 ${lFileName}) ]]; then
	head -1 ${lFileName} >> ${lTmpFile}
	lOffset=1
    fi

    printCopyrightText ${lFileName} "${lBeginComment}" "${lComment}" "${lEndComment}" >> ${lTmpFile}
    tail -n +$((lOffset + 1)) ${lFileName} >> ${lTmpFile}
    mv ${lTmpFile} ${lFileName}
}

#----------------------------------------------
isPython()
{
    local lFileName=${1}
    if [[ ${lFileName##*.} == 'py' ]] || [[ -n $(head -1 ${lFileName} | grep python) ]]; then
	echo 1
    else
	echo 0
    fi
}

#----------------------------------------------
# Main script
#----------------------------------------------

if [[ $# -lt 1 ]]; then
    echo "Usage: $(basename ${0}) [-r] fileName"
    exit 1
fi

ARGS=$(getopt -o hr -l "help,replace" -n "$(basename ${0})" -- "$@")

# If wrong arguments, print usage and exit
if [[ $? -ne 0 ]]; then
    printUsage
    exit 1;
fi

eval set -- "$ARGS"

## Parse options
doReplace=0
while true; do
    case ${1} in
	-h|--help)
	    printUsage
	    exit 0
	    ;;
	-r|--replace)
	    doReplace=1
	    shift
	    ;;
	--)
	    shift
	    break
	    ;;
    esac
done

fileName=${1}

# 
if [[ ${doReplace} = 1 ]] || [[ -z $(grep "Katania Copyright" ${fileName}) ]]; then
    if [[ $(isPython ${fileName}) == 1 ]]; then
	handlePython ${fileName} ${doReplace}
    else
	handleCpp ${fileName} ${doReplace}
    fi
fi

exit 0
