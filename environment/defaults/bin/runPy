#!/bin/bash


#----------------------------------------------
printUsage()
{
cat << %%USAGE%%
     Usage: $(basename ${0}) [-h]
            $(basename ${0}) [options] -- [job command and params]

     Options
       -h
       --help
             Print this help message and exit.

       --roc
             Run a ROCARDIAN job, instead of the default RONIN one.

       -d
       --debug
             Run the Debug build, instead of the Release one.

       -b branchName
       --branch branchName
             Run the code from the specified branch instead of master. This applies
	     to both the C++ and the Python code.

       --codePath path
             Use the specified path as code path, instead of ${HOME}/code.

       --pythonPath path
             Specifies additional directories to be added to the PYTHONPATH 
             environment variable.

       --printPaths
             Prints the paths that are set before calling the python script and exits.

%%USAGE%%
}

#----------------------------------------------
# Main script
#----------------------------------------------
ARGS=$(getopt -o hdb: -l "help,roc,branch:,codePath:,pythonPath:,printPaths" -n "$(basename ${0})" -- "$@")

# If wrong arguments, print usage and exit
if [[ $? -ne 0 ]]; then
    printUsage
    exit 1;
fi

eval set -- "$ARGS"

## Parse options
client=ronin
branchName=master
pythonPath=''
printPath=0
codePath=${HOME}/code/drogon
buildType=Release
while true; do
    case ${1} in
	-h|--help)
	    printUsage
	    exit 0
	    ;;
	--roc)
	    client=rocardian
	    shift
	    ;;
	-d|--debug)
	    buildType=Debug
	    shift
	    ;;
	-b|--branch)
	    branchName=${2}
	    shift 2
	    ;;
        --codePath)
	    codePath=${2}
	    shift 2
	    ;;
	--pythonPath)
            pythonPath=${2}
            shift 2
            ;;
	--printPaths)
	    printPaths=1
	    shift
	    ;;
	--)
	    shift
	    break
	    ;;
	"")
	    # This is necessary for processing missing optional arguments 
	    shift
	    ;;
    esac
done

# Create and check the lib path
libPath=${HOME}/deploy/${branchName}/${buildType}/lib
if [[ ! -d ${libPath} ]]; then
   printf "Library path not found: ${libPath}\n"
   exit 1
fi
clientLibPath=${libPath}/${client}
if [[ ! -d ${clientLibPath} ]]; then
   printf "Client library path not found: ${clientLibPath}\n"
   exit 1
else
    initFile=${clientLibPath}/__init__.py
    if [[ ! -f ${initFile} ]]; then
	touch ${initFile}
    fi
fi



if [[ ! -d ${codePath} ]]; then
   printf "Code path not found: ${codePath}\n"
   exit 1
fi

codeBranch=$(cd ${codePath} && branch -ls | awk '{print $2} ' | sort -u)
if [[ ${codeBranch} != ${branchName} ]]; then
    printf "Branch of the code is '%s', different than '%s'\n" ${codeBranch} ${branchName}
    exit 1
fi

ldLibPath=${libPath}:${codePath}/lib/portfolio/lib
pyPath=${codePath}/src/python:${codePath}/src/C/marketdata_CME/python:${codePath}/lib/cvxopt-1.1.6/python:${codePath}/lib/python-bindings:${libPath}:${codePath}/lib/portfolio/lib:${pythonPath}

if [[ ${printPaths} == 1 ]]; then
    echo "Printing paths:"
    echo export LD_LIBRARY_PATH=${ldLibPath} 
    echo export PYTHONPATH=${pyPath} 
    echo export PYCLIENT=${client}
    exit 0
fi


LD_LIBRARY_PATH=${ldLibPath} PYTHONPATH=${pyPath} PYCLIENT=${client} $@ || exit $?
